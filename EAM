# Employee Attendance Management System
# A complete Python application for tracking employee attendance

import sqlite3
import hashlib
from datetime import datetime, date, timedelta
import getpass
import os

class Database:
    """Database handler for the attendance system"""
    
    def __init__(self, db_name="attendance.db"):
        self.db_name = db_name
        self.init_database()
    
    def get_connection(self):
        """Get database connection"""
        return sqlite3.connect(self.db_name)
    
    def init_database(self):
        """Initialize database tables"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # Create users table (for both admin and employees)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                full_name TEXT NOT NULL,
                email TEXT,
                role TEXT NOT NULL DEFAULT 'employee',
                department TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT 1
            )
        ''')
        
        # Create attendance table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS attendance (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                date DATE NOT NULL,
                check_in_time TIMESTAMP,
                check_out_time TIMESTAMP,
                status TEXT DEFAULT 'present',
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (id),
                UNIQUE(user_id, date)
            )
        ''')
        
        # Create default admin user if not exists
        cursor.execute('''
            INSERT OR IGNORE INTO users 
            (username, password, full_name, email, role) 
            VALUES (?, ?, ?, ?, ?)
        ''', ('admin', self.hash_password('admin123'), 'System Administrator', 
              'admin@company.com', 'admin'))
        
        conn.commit()
        conn.close()
        print("Database initialized successfully!")
    
    def hash_password(self, password):
        """Hash password using SHA-256"""
        return hashlib.sha256(password.encode()).hexdigest()

class User:
    """User authentication and management"""
    
    def __init__(self, db):
        self.db = db
    
    def register_employee(self, username, password, full_name, email, department):
        """Register a new employee"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        try:
            hashed_password = self.db.hash_password(password)
            cursor.execute('''
                INSERT INTO users (username, password, full_name, email, department, role)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (username, hashed_password, full_name, email, department, 'employee'))
            
            conn.commit()
            conn.close()
            return True, "Employee registered successfully!"
        
        except sqlite3.IntegrityError:
            conn.close()
            return False, "Username already exists!"
        except Exception as e:
            conn.close()
            return False, f"Error: {str(e)}"
    
    def authenticate(self, username, password):
        """Authenticate user login"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        hashed_password = self.db.hash_password(password)
        cursor.execute('''
            SELECT id, username, full_name, role, is_active 
            FROM users 
            WHERE username = ? AND password = ? AND is_active = 1
        ''', (username, hashed_password))
        
        user = cursor.fetchone()
        conn.close()
        
        if user:
            return {
                'id': user[0],
                'username': user[1],
                'full_name': user[2],
                'role': user[3],
                'is_active': user[4]
            }
        return None
    
    def get_all_employees(self):
        """Get all employees (admin function)"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, username, full_name, email, department, created_at, is_active
            FROM users 
            WHERE role = 'employee'
            ORDER BY full_name
        ''')
        
        employees = cursor.fetchall()
        conn.close()
        return employees

class Attendance:
    """Attendance management system"""
    
    def __init__(self, db):
        self.db = db
    
    def check_in(self, user_id):
        """Employee check-in"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        today = date.today()
        now = datetime.now()
        
        try:
            # Check if already checked in today
            cursor.execute('''
                SELECT id, check_in_time FROM attendance 
                WHERE user_id = ? AND date = ?
            ''', (user_id, today))
            
            existing = cursor.fetchone()
            
            if existing:
                if existing[1]:  # Already checked in
                    conn.close()
                    return False, "Already checked in today!"
                else:
                    # Update existing record
                    cursor.execute('''
                        UPDATE attendance 
                        SET check_in_time = ?, status = 'present'
                        WHERE user_id = ? AND date = ?
                    ''', (now, user_id, today))
            else:
                # Create new attendance record
                cursor.execute('''
                    INSERT INTO attendance (user_id, date, check_in_time, status)
                    VALUES (?, ?, ?, 'present')
                ''', (user_id, today, now))
            
            conn.commit()
            conn.close()
            return True, f"Checked in successfully at {now.strftime('%H:%M:%S')}"
        
        except Exception as e:
            conn.close()
            return False, f"Error: {str(e)}"
    
    def check_out(self, user_id):
        """Employee check-out"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        today = date.today()
        now = datetime.now()
        
        try:
            cursor.execute('''
                SELECT id, check_in_time, check_out_time FROM attendance 
                WHERE user_id = ? AND date = ?
            ''', (user_id, today))
            
            record = cursor.fetchone()
            
            if not record:
                conn.close()
                return False, "No check-in record found for today!"
            
            if not record[1]:  # No check-in time
                conn.close()
                return False, "Please check-in first!"
            
            if record[2]:  # Already checked out
                conn.close()
                return False, "Already checked out today!"
            
            # Update check-out time
            cursor.execute('''
                UPDATE attendance 
                SET check_out_time = ?
                WHERE user_id = ? AND date = ?
            ''', (now, user_id, today))
            
            conn.commit()
            conn.close()
            return True, f"Checked out successfully at {now.strftime('%H:%M:%S')}"
        
        except Exception as e:
            conn.close()
            return False, f"Error: {str(e)}"
    
    def get_employee_attendance(self, user_id, days=30):
        """Get employee attendance for last N days"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        start_date = date.today() - timedelta(days=days)
        
        cursor.execute('''
            SELECT date, check_in_time, check_out_time, status, notes
            FROM attendance 
            WHERE user_id = ? AND date >= ?
            ORDER BY date DESC
        ''', (user_id, start_date))
        
        records = cursor.fetchall()
        conn.close()
        return records
    
    def get_all_attendance(self, target_date=None):
        """Get all employees attendance for a specific date (admin function)"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        if not target_date:
            target_date = date.today()
        
        cursor.execute('''
            SELECT u.full_name, u.department, a.date, a.check_in_time, 
                   a.check_out_time, a.status, a.notes
            FROM users u
            LEFT JOIN attendance a ON u.id = a.user_id AND a.date = ?
            WHERE u.role = 'employee' AND u.is_active = 1
            ORDER BY u.full_name
        ''', (target_date,))
        
        records = cursor.fetchall()
        conn.close()
        return records
    
    def get_attendance_summary(self, user_id=None, days=30):
        """Get attendance summary statistics"""
        conn = self.db.get_connection()
        cursor = conn.cursor()
        
        start_date = date.today() - timedelta(days=days)
        
        if user_id:
            # Individual employee summary
            cursor.execute('''
                SELECT 
                    COUNT(*) as total_days,
                    SUM(CASE WHEN status = 'present' THEN 1 ELSE 0 END) as present_days,
                    SUM(CASE WHEN status = 'absent' THEN 1 ELSE 0 END) as absent_days
                FROM attendance 
                WHERE user_id = ? AND date >= ?
            ''', (user_id, start_date))
        else:
            # Overall summary (admin view)
            cursor.execute('''
                SELECT 
                    COUNT(DISTINCT user_id) as total_employees,
                    COUNT(*) as total_records,
                    SUM(CASE WHEN status = 'present' THEN 1 ELSE 0 END) as present_count,
                    SUM(CASE WHEN status = 'absent' THEN 1 ELSE 0 END) as absent_count
                FROM attendance 
                WHERE date >= ?
            ''', (start_date,))
        
        summary = cursor.fetchone()
        conn.close()
        return summary

class AttendanceApp:
    """Main application class"""
    
    def __init__(self):
        self.db = Database()
        self.user_manager = User(self.db)
        self.attendance_manager = Attendance(self.db)
        self.current_user = None
    
    def clear_screen(self):
        """Clear console screen"""
        os.system('cls' if os.name == 'nt' else 'clear')
    
    def display_header(self):
        """Display application header"""
        print("="*60)
        print("SLVE EMPLOYEE ATTENDANCE MANAGEMENT SYSTEM")
        print("="*60)
        if self.current_user:
            print(f"Logged in as: {self.current_user['full_name']} ({self.current_user['role'].upper()})")
            print("-"*60)
    
    def login(self):
        """User login interface"""
        self.clear_screen()
        self.display_header()
        
        print("\n LOGIN")
        print("-"*20)
        
        username = input("Username: ").strip()
        password = getpass.getpass("Password: ")
        
        user = self.user_manager.authenticate(username, password)
        
        if user:
            self.current_user = user
            print(f"\nWelcome, {user['full_name']}!")
            input("Press Enter to continue...")
            return True
        else:
            print("\nInvalid credentials!")
            input("Press Enter to try again...")
            return False
    
    def admin_menu(self):
        """Admin menu interface"""
        while True:
            self.clear_screen()
            self.display_header()
            
            print("\n ADMIN MENU")
            print("-"*20)
            print("1. Register New Employee")
            print("2. View All Employees")
            print("3. View Daily Attendance")
            print("4. Attendance Summary")
            print("5. Employee Attendance Report")
            print("0. Logout")
            
            choice = input("\nEnter your choice: ").strip()
            
            if choice == '1':
                self.register_employee()
            elif choice == '2':
                self.view_all_employees()
            elif choice == '3':
                self.view_daily_attendance()
            elif choice == '4':
                self.attendance_summary()
            elif choice == '5':
                self.employee_attendance_report()
            elif choice == '0':
                self.current_user = None
                break
            else:
                print("Invalid choice!")
                input("Press Enter to continue...")
    
    def employee_menu(self):
        """Employee menu interface"""
        while True:
            self.clear_screen()
            self.display_header()
            
            print("\n EMPLOYEE MENU")
            print("-"*20)
            print("1. Check In")
            print("2. Check Out")
            print("3. View My Attendance")
            print("4. My Attendance Summary")
            print("0. Logout")
            
            choice = input("\nEnter your choice: ").strip()
            
            if choice == '1':
                self.check_in()
            elif choice == '2':
                self.check_out()
            elif choice == '3':
                self.view_my_attendance()
            elif choice == '4':
                self.my_attendance_summary()
            elif choice == '0':
                self.current_user = None
                break
            else:
                print("Invalid choice!")
                input("Press Enter to continue...")
    
    def register_employee(self):
        """Register new employee (admin function)"""
        self.clear_screen()
        self.display_header()
        
        print("\n REGISTER NEW EMPLOYEE")
        print("-"*30)
        
        username = input("Username: ").strip()
        password = getpass.getpass("Password: ")
        full_name = input("Full Name: ").strip()
        email = input("Email: ").strip()
        department = input("Department: ").strip()
        
        if username and password and full_name:
            success, message = self.user_manager.register_employee(
                username, password, full_name, email, department)
            print(f"\n{message}")
        else:
            print("\nPlease fill all required fields!")
        
        input("Press Enter to continue...")
    
    def view_all_employees(self):
        """View all employees (admin function)"""
        self.clear_screen()
        self.display_header()
        
        print("\n ALL EMPLOYEES")
        print("-"*50)
        
        employees = self.user_manager.get_all_employees()
        
        if employees:
            print(f"{'ID':<5} {'Username':<15} {'Full Name':<25} {'Department':<15} {'Status':<10}")
            print("-"*80)
            
            for emp in employees:
                status = "Active" if emp[6] else "Inactive"
                print(f"{emp[0]:<5} {emp[1]:<15} {emp[2]:<25} {emp[4] or 'N/A':<15} {status:<10}")
        else:
            print("No employees found!")
        
        input("\nPress Enter to continue...")
    
    def check_in(self):
        """Employee check-in"""
        success, message = self.attendance_manager.check_in(self.current_user['id'])
        
        self.clear_screen()
        self.display_header()
        
        print("\n CHECK-IN")
        print("-"*15)
        print(f"\n{message}")
        
        input("Press Enter to continue...")
    
    def check_out(self):
        """Employee check-out"""
        success, message = self.attendance_manager.check_out(self.current_user['id'])
        
        self.clear_screen()
        self.display_header()
        
        print("\n CHECK-OUT")
        print("-"*16)
        print(f"\n{message}")
        
        input("Press Enter to continue...")
    
    def view_my_attendance(self):
        """View employee's own attendance"""
        self.clear_screen()
        self.display_header()
        
        print("\n MY ATTENDANCE HISTORY")
        print("-"*30)
        
        records = self.attendance_manager.get_employee_attendance(self.current_user['id'])
        
        if records:
            print(f"{'Date':<12} {'Check-In':<20} {'Check-Out':<20} {'Status':<10}")
            print("-"*70)
            
            for record in records:
                check_in = record[1][:19] if record[1] else 'N/A'
                check_out = record[2][:19] if record[2] else 'N/A'
                print(f"{record[0]:<12} {check_in:<20} {check_out:<20} {record[3]:<10}")
        else:
            print("No attendance records found!")
        
        input("\nPress Enter to continue...")
    
    def view_daily_attendance(self):
        """View daily attendance (admin function)"""
        self.clear_screen()
        self.display_header()
        
        print("\n DAILY ATTENDANCE")
        print("-"*25)
        
        date_input = input("Enter date (YYYY-MM-DD) or press Enter for today: ").strip()
        
        if date_input:
            try:
                target_date = datetime.strptime(date_input, '%Y-%m-%d').date()
            except ValueError:
                print("Invalid date format!")
                input("Press Enter to continue...")
                return
        else:
            target_date = date.today()
        
        records = self.attendance_manager.get_all_attendance(target_date)
        
        print(f"\nAttendance for {target_date}")
        print("-"*50)
        
        if records:
            print(f"{'Employee':<25} {'Department':<15} {'Check-In':<20} {'Check-Out':<20} {'Status':<10}")
            print("-"*100)
            
            for record in records:
                check_in = record[3][:19] if record[3] else 'N/A'
                check_out = record[4][:19] if record[4] else 'N/A'
                status = record[5] if record[5] else 'Absent'
                
                print(f"{record[0]:<25} {record[1] or 'N/A':<15} {check_in:<20} {check_out:<20} {status:<10}")
        else:
            print("No records found!")
        
        input("\nPress Enter to continue...")
    
    def attendance_summary(self):
        """Attendance summary (admin function)"""
        self.clear_screen()
        self.display_header()
        
        print("\n ATTENDANCE SUMMARY")
        print("-"*28)
        
        summary = self.attendance_manager.get_attendance_summary()
        
        if summary:
            print(f"Total Employees: {summary[0]}")
            print(f"Total Records: {summary[1]}")
            print(f"Present Count: {summary[2]}")
            print(f"Absent Count: {summary[3]}")
            
            if summary[1] > 0:
                attendance_rate = (summary[2] / summary[1]) * 100
                print(f"Attendance Rate: {attendance_rate:.2f}%")
        else:
            print("No data available!")
        
        input("\nPress Enter to continue...")
    
    def my_attendance_summary(self):
        """Employee's attendance summary"""
        self.clear_screen()
        self.display_header()
        
        print("\n MY ATTENDANCE SUMMARY")
        print("-"*30)
        
        summary = self.attendance_manager.get_attendance_summary(self.current_user['id'])
        
        if summary and summary[0] > 0:
            print(f"Total Days Recorded: {summary[0]}")
            print(f"Present Days: {summary[1]}")
            print(f"Absent Days: {summary[2]}")
            
            attendance_rate = (summary[1] / summary[0]) * 100
            print(f"Attendance Rate: {attendance_rate:.2f}%")
        else:
            print("No attendance data available!")
        
        input("\nPress Enter to continue...")
    
    def employee_attendance_report(self):
        """Individual employee attendance report (admin function)"""
        self.clear_screen()
        self.display_header()
        
        print("\n EMPLOYEE ATTENDANCE REPORT")
        print("-"*35)
        
        # Show all employees first
        employees = self.user_manager.get_all_employees()
        
        if not employees:
            print("No employees found!")
            input("Press Enter to continue...")
            return
        
        print("\nAvailable Employees:")
        for emp in employees:
            print(f"{emp[0]}: {emp[2]} ({emp[1]})")
        
        try:
            emp_id = int(input("\nEnter Employee ID: "))
            
            records = self.attendance_manager.get_employee_attendance(emp_id)
            
            if records:
                # Find employee name
                emp_name = next((emp[2] for emp in employees if emp[0] == emp_id), "Unknown")
                
                print(f"\nAttendance Report for: {emp_name}")
                print("-"*50)
                print(f"{'Date':<12} {'Check-In':<20} {'Check-Out':<20} {'Status':<10}")
                print("-"*70)
                
                for record in records:
                    check_in = record[1][:19] if record[1] else 'N/A'
                    check_out = record[2][:19] if record[2] else 'N/A'
                    print(f"{record[0]:<12} {check_in:<20} {check_out:<20} {record[3]:<10}")
            else:
                print("No attendance records found for this employee!")
        
        except ValueError:
            print("Invalid Employee ID!")
        
        input("\nPress Enter to continue...")
    
    def run(self):
        """Main application loop"""
        print("Starting Employee Attendance Management System...")
        
        while True:
            if not self.current_user:
                if not self.login():
                    continue
            
            if self.current_user['role'] == 'admin':
                self.admin_menu()
            else:
                self.employee_menu()


# SQL Queries used in the system (for reference)
SQL_QUERIES = """
-- Database Schema Creation Queries:

-- Create users table
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    full_name TEXT NOT NULL,
    email TEXT,
    role TEXT NOT NULL DEFAULT 'employee',
    department TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);

-- Create attendance table
CREATE TABLE IF NOT EXISTS attendance (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    date DATE NOT NULL,
    check_in_time TIMESTAMP,
    check_out_time TIMESTAMP,
    status TEXT DEFAULT 'present',
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id),
    UNIQUE(user_id, date)
);

-- Data Retrieval Queries:

-- Get user authentication
SELECT id, username, full_name, role, is_active 
FROM users 
WHERE username = ? AND password = ? AND is_active = 1;

-- Get employee attendance history
SELECT date, check_in_time, check_out_time, status, notes
FROM attendance 
WHERE user_id = ? AND date >= ?
ORDER BY date DESC;

-- Get daily attendance report (all employees)
SELECT u.full_name, u.department, a.date, a.check_in_time, 
       a.check_out_time, a.status, a.notes
FROM users u
LEFT JOIN attendance a ON u.id = a.user_id AND a.date = ?
WHERE u.role = 'employee' AND u.is_active = 1
ORDER BY u.full_name;

-- Get attendance summary statistics
SELECT 
    COUNT(*) as total_days,
    SUM(CASE WHEN status = 'present' THEN 1 ELSE 0 END) as present_days,
    SUM(CASE WHEN status = 'absent' THEN 1 ELSE 0 END) as absent_days
FROM attendance 
WHERE user_id = ? AND date >= ?;

-- Data Modification Queries:

-- Insert new employee
INSERT INTO users (username, password, full_name, email, department, role)
VALUES (?, ?, ?, ?, ?, 'employee');

-- Insert attendance check-in
INSERT INTO attendance (user_id, date, check_in_time, status)
VALUES (?, ?, ?, 'present');

-- Update attendance check-out
UPDATE attendance 
SET check_out_time = ?
WHERE user_id = ? AND date = ?;
"""

if __name__ == "__main__":
    # Initialize and run the application
    app = AttendanceApp()
    
    print("\n" + "="*60)
    print("EMPLOYEE ATTENDANCE MANAGEMENT SYSTEM")
    print("="*60)
    print("\nDefault Admin Credentials:")
    print("Username: admin")
    print("Password: admin123")
    print("\nNote: Please change the default admin password after first login!")
    print("="*60)
    
    try:
        app.run()
    except KeyboardInterrupt:
        print("\n\nApplication terminated by user.")
    except Exception as e:
        print(f"\nAn error occurred: {str(e)}")
    finally:
        print("\nThank you for using Employee Attendance Management System!")
